#!/usr/bin/env bash
set -eo pipefail

# The post_compile hook is run by heroku-buildpack-python

echo "-----> I'm post-compile hook"

if [ ! -d $TARGET_DIR/gettext ]; then
    echo "-----> Installing gettext msgfmt..."

    GETTEXT_CHECKSUM="ceZfT0KqGBZyr52s/9yULR3vsmXPS5HmUcs+dup/DXg="
    GETTEXT_TARBALL=https://s3-eu-west-1.amazonaws.com/midgard-heroku/gettext.tar.gz

    # tempdir="$( mktemp -t gettext_XXXX )"
    # rm -rf $tempdir
    # mkdir -p $tempdir
    pushd $BUILD_DIR >/dev/null
    rm -f tmp-gettext.tar.gz

    curl -s -L -o tmp-gettext.tar.gz "$GETTEXT_TARBALL"
    if [ "$GETTEXT_CHECKSUM" != "$(openssl sha -sha256 -binary tmp-gettext.tar.gz | openssl base64)" ]; then
        echo "Checksum DOES NOT match. Gettext will not be installed."
        exit 1
    fi
    tar -zxvf tmp-gettext.tar.gz > /dev/null
    rm tmp-gettext.tar.gz
    popd >/dev/null

    export PATH=$BUILD_DIR/gettext/bin:$PATH

    # ln -s -f ../../vendor/gettext/bin/msgfmt .heroku/python/bin/msgfmt

    echo "-----> done installing gettext msgfmt"
fi

if [ -f bin/run_migrations ]; then
    echo "-----> Running run_migrations"
    chmod +x bin/run_migrations
    bin/run_migrations
fi

echo "-----> Post-compile done"
